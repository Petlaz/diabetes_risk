# =============================================================================
# docker-compose.yml - Orchestration for Diabetes Risk Assessment Platform
# =============================================================================
#
# What this file does:
# - Orchestrates the complete diabetes platform deployment
# - Manages service configuration, networking, and volumes
# - Enables easy startup with: docker-compose up diabetes-xai-gradio
# - Provides development and production service configurations
#
# Services included:
# - diabetes-xai-gradio: Main clinical platform with Gradio interface
# - health-xai-dev: Development environment for testing
#
# Clinical Platform Features:
# - Real-time diabetes risk predictions (8.9/10 clinical validation)
# - SHAP/LIME explainable AI with 8 features each
# - Professional medical interface without AI-generated language
# - Random Forest model with 100% sensitivity
# =============================================================================

services:
  diabetes-xai-gradio:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    ports:
      - "7860:7860"  # Gradio diabetes XAI app
    volumes:
      - ../data:/app/data
      - ../results:/app/results
      - ../app:/app/app
      - ../src:/app/src
    environment:
      - PYTHONPATH=/app/src:/app
      - GRADIO_SERVER_NAME=0.0.0.0
      - GRADIO_SERVER_PORT=7860
      - GRADIO_SHARE=true  # Enable public URL sharing
      - MPLBACKEND=Agg  # Non-interactive matplotlib backend
    # Use direct Python execution to avoid CLI issues
    command: ["/entrypoint.sh"]
    
  health-xai-dev:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    ports:
      - "7861:7860"  # Alternative Gradio port for development
      - "8888:8888"  # Jupyter notebooks
    volumes:
      - ../data:/app/data
      - ../results:/app/results
      - ../notebooks:/app/notebooks
      - ../app:/app/app
      - ../src:/app/src
    environment:
      - PYTHONPATH=/app/src:/app
      - JUPYTER_ENABLE_LAB=yes
      - MPLBACKEND=Agg
    command: ["jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser", "--allow-root", "--NotebookApp.token=''"]
    
  xai-test:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    volumes:
      - ../data:/app/data
      - ../results:/app/results
      - ../notebooks:/app/notebooks
      - ../src:/app/src
    environment:
      - PYTHONPATH=/app/src:/app
      - MPLBACKEND=Agg
    command: ["python", "docker/test_xai_docker.py"]
    profiles:
      - test  # Only run when explicitly requested
    
  # Optional: Add a database service for future enhancements
  # postgres:
  #   image: postgres:13
  #   environment:
  #     POSTGRES_DB: health_xai
  #     POSTGRES_USER: user
  #     POSTGRES_PASSWORD: password
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   ports:
  #     - "5432:5432"

# volumes:
#   postgres_data: